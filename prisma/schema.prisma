generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              String              @id @default("")
  email           String              @unique
  name            String?
  password        String
  role            Role                @default(USER)
  isActive        Boolean             @default(true)
  avatar          String?
  lastLoginAt     DateTime?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  balance         Float               @default(0)
  invoices        Invoice[]
  loginHistory    LoginHistory[]
  orders          Order[]
  pteroServers    PterodactylServer[]
  services        Service[]
  sessions        Session[]
  transactions    WalletTransaction[]
  deposits        DepositRequest[]
  paymentSetting  PaymentSetting?
  assignedServers ServerSettings[]
}

model Session {
  id        String   @id @default("")
  userId    String
  token     String   @unique @db.VarChar(1000)
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Service {
  id          String        @id @default("")
  name        String
  type        ServiceType
  status      ServiceStatus @default(PENDING)
  price       Float
  config      Json?
  ip          String?
  port        Int?
  description String?
  userId      String
  expiresAt   DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  orders      Order[]
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id              String      @id @default("")
  userId          String
  storeId         String?
  serviceId       String?
  amount          Float
  status          OrderStatus @default(PENDING)
  paymentMethod   String?
  paymentProof    String?
  adminNotes      String?     // Notes from admin/owner
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  invoices        Invoice[]
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  storeItem       StoreItem?  @relation(fields: [storeId], references: [id])
  service         Service?    @relation(fields: [serviceId], references: [id])
}

model PterodactylServer {
  id              String   @id @default("")
  pteroId         String   @unique
  uuid            String   @unique
  identifier      String   @unique
  name            String
  description     String?
  status          String
  suspended       Boolean  @default(false)
  limits          Json
  featureLimits   Json
  userId          String?
  nodeId          String
  allocationId    String
  allocationIp    String?
  allocationPort  Int?
  allocationAlias String?
  nestId          String
  eggId           String
  container       Json?
  cpuUsage        Float?
  memoryUsage     Int?
  memoryLimit     Int?
  diskUsage       Int?
  diskLimit       Int?
  networkRx       Int?
  networkTx       Int?
  uptime          Int?
  lastSyncAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User?    @relation(fields: [userId], references: [id])
  settings        ServerSettings?
}

model ServerSettings {
  id                String   @id @default("")
  pterodactylServerId String   @unique
  assignedUserId    String?
  panelUrl          String?
  txadminUrl        String?
  databaseHost      String?
  databasePort      Int?
  databaseName      String?
  databaseUser      String?
  databasePassword  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  pterodactylServer PterodactylServer @relation(fields: [pterodactylServerId], references: [pteroId], onDelete: Cascade)
  assignedUser      User?    @relation(fields: [assignedUserId], references: [id])
}

model ApiConfiguration {
  id          String   @id @default("")
  name        String   @unique
  apiUrl      String
  apiKey      String
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LoginHistory {
  id        String   @id @default("")
  userId    String
  loginTime DateTime @default(now())
  ip        String
  userAgent String
  location  String?
  device    String?
  browser   String?
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([loginTime])
}

model StoreItem {
  id          String        @id @default("")
  title       String        @unique
  description String?
  price       Float
  category    StoreCategory
  imageUrl    String?
  imageLink   String?
  isActive    Boolean       @default(true)
  featured    Boolean       @default(false)
  metadata    Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  orders      Order[]
}

model Invoice {
  id            String        @id @default("")
  invoiceNumber String        @unique
  userId        String
  orderId       String?
  title         String
  description   String?
  amount        Float
  status        InvoiceStatus @default(PENDING)
  dueDate       DateTime
  paidAt        DateTime?
  paymentMethod String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  order         Order?        @relation(fields: [orderId], references: [id])
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model WalletTransaction {
  id          String          @id @default("")
  userId      String
  type        TransactionType
  amount      Float
  description String?
  balance     Float
  metadata    Json?
  createdAt   DateTime        @default(now())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  deposits    DepositRequest[]
}

model DepositRequest {
  id            String           @id @default("")
  userId        String
  amount        Float
  paymentMethod String
  proofUrl    String?
  status        DepositStatus    @default(PENDING)
  adminNotes    String?
  processedBy   String?          // Admin/Owner ID who processed this
  processedAt   DateTime?
  transactionId String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction   WalletTransaction? @relation(fields: [transactionId], references: [id])
}

model PaymentMethod {
  id        String           @id @default("")
  name      String
  type      PaymentMethodType
  config    Json
  isActive  Boolean          @default(true)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model PaymentSetting {
  id            String   @id @default("")
  ownerUserId   String   @unique
  qrisImageUrl  String?
  qrisNumber    String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  ownerUser     User     @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  banks         BankAccount[]
  ewallets      EWalletAccount[]
}

model BankAccount {
  id              String @id @default("")
  paymentSettingId String
  bankName        String
  bankNumber      String
  bankAccount     String
  isActive        Boolean @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  paymentSetting  PaymentSetting @relation(fields: [paymentSettingId], references: [id], onDelete: Cascade)
}

model EWalletAccount {
  id                String @id @default("")
  paymentSettingId  String
  ewalletName       String
  ewalletNumber     String
  isActive          Boolean @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  paymentSetting    PaymentSetting @relation(fields: [paymentSettingId], references: [id], onDelete: Cascade)
}

enum Role {
  USER
  ADMIN
  OWNER
}

enum ServiceType {
  GAME_HOSTING
  RDP
  FIVEM_DEVELOPMENT
  ROBLOX_DEVELOPMENT
}

enum ServiceStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum OrderStatus {
  PENDING
  VALIDATING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

enum TransactionType {
  TOP_UP
  PAYMENT
  REFUND
  BONUS
  PENALTY
}

enum DepositStatus {
  PENDING
  VALIDATING
  APPROVED
  REJECTED
}

enum PaymentMethodType {
  QRIS
  BANK_TRANSFER
  EWALLET
}

enum StoreCategory {
  MOD
  GAME
  HOSTING
  SERVER
}
